Thanks for confirming â€” since **everything works perfectly in Replit**, but the **live Render dashboard still isn't showing the customer queue**, even **after testing in private mode and re-logging**, that narrows it down to a **server-side or WebSocket-related issue in the production environment**.

---

## âœ… Here's a Summary of What We've Confirmed:

| Area                     | Status        | Working in Replit | Working in Render |
|--------------------------|---------------|--------------------|--------------------|
| App build & deployment  | âœ… Successful | âœ… Yes              | âœ… Yes              |
| Login                   | âœ… Works       | âœ… Yes              | âœ… Yes              |
| Neon database connection| âœ… Confirmed   | âœ… Yes              | âœ… Yes              |
| WebSocket connection    | âš ï¸ Fails in prod | âœ… Yes              | âŒ No (Code 1006)  |
| Dashboard shows data    | âœ… Yes (Replit) | âœ… Yes              | âŒ No              |

---

## ðŸš¨ Root Cause: **WebSocket Connection Not Persisting in Production**

> **WebSocket Error Code 1006** = _Abnormal closure_ â†’ usually means:
- Handshake failed due to CORS or wrong `Origin`
- Render is dropping connection due to missing `ping/pong`
- Session cookie is not sent in WebSocket request
- WS server didn't properly attach to Express

---

## âœ… Final Checklist Before Touching Code:

Please confirm the **following are ALL true on Render**:

### 1. âœ… `RENDER_EXTERNAL_HOSTNAME` is set (or correctly inferred)
```env
RENDER_EXTERNAL_HOSTNAME=uireplicator.onrender.com
```

### 2. âœ… `NODE_ENV=production` is set  
Youâ€™ve already done this â€” good.

---

## ðŸ§ª Now, hereâ€™s how to **verify where exactly the failure is happening:**

### ðŸ” Step 1: Open DevTools â†’ Network Tab â†’ Filter: `WS`

- Check if `wss://uireplicator.onrender.com` is being **called**
- See the **status** (should be `101 Switching Protocols`)
- If you see `failed` or `pending`, click it â†’ look under:
  - **Headers â†’ Request**: Check if cookies/session are attached
  - **Response â†’ Console log**: Any CORS issues?

---

## âœ… Debugging Fixes (To Be Done Only If You Approve)

Let me break this into **two safe optional fix paths** you can choose to apply:

---

### âœ… Fix A: Attach WebSocket Server *After* Express Server is Ready

This ensures Renderâ€™s internal reverse proxy **doesnâ€™t drop the WebSocket** due to timing.

#### ðŸ”§ In `server/index.ts`:
Make sure you do this **order**:

```ts
const server = app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

const wss = new WebSocketServer({ server });

wss.on("connection", (socket) => {
  console.log("WebSocket connection established");

  // Your message handlers...
});
```

âœ… Confirm `wss` is using `{ server }` and not raw port or app.

---

### âœ… Fix B: Handle WebSocket `ping/pong` heartbeats in production

Some platforms like Render **close idle WS connections**.

#### ðŸ› ï¸ Add this inside `wss.on("connection")` block:
```ts
socket.isAlive = true;

socket.on("pong", () => {
  socket.isAlive = true;
});

const interval = setInterval(() => {
  wss.clients.forEach((ws) => {
    if (!ws.isAlive) return ws.terminate();

    ws.isAlive = false;
    ws.ping();
  });
}, 30000);

wss.on("close", () => {
  clearInterval(interval);
});
```

âœ… This keeps the connection alive with a 30s heartbeat ping.

---

## ðŸ“¦ Bonus: Fix WebSocket URL Detection in Frontend

In `BarberDashboard.jsx` or wherever you're connecting WebSockets:

```js
const getWebSocketUrl = () => {
  if (import.meta.env.PROD) {
    return `wss://${window.location.host}`;
  } else {
    return "ws://localhost:3001";
  }
};
const socket = new WebSocket(getWebSocketUrl());
```

âœ… This ensures the client points to the **correct host dynamically**.

---

## âœ… Final Step: Confirm Express Session is Attached to WebSocket

Sessions donâ€™t work over WS unless cookies are passed.

Make sure in your session setup you have:

```ts
cookie: {
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'none',
  httpOnly: true,
}
```

And that your WebSocket path **doesn't conflict** (like using `/socket`).

---

## ðŸ”§ Summary â€” What To Fix:

| Fix                        | Status    |
|-----------------------------|-----------|
| Attach WebSocket after Express `listen()` | âœ… Do this |
| Add `ping/pong` for WebSocket | âœ… Do this |
| Use dynamic `wss://` URL on frontend | âœ… Do this |
| Verify Render session cookies working | âœ… Confirm |
| WebSocket response: 101 Switching Protocols? | ðŸ§ª Check |

---

## ðŸš€ Want Me to Write the Code Changes?

If you give me a âœ…, Iâ€™ll generate all the exact file updates you can paste and push in Replit â†’ GitHub â†’ Render.

Let me know if you'd like:
- [ ] Just backend changes
- [ ] Both backend and frontend WebSocket fix
- [ ] Final `git push` checklist

Or if you want to **deploy to Fly.io instead**, Iâ€™ll switch and guide you instantly.